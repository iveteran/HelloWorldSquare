#!/bin/bash
#
# 使用 IMAP XOAUTH2 方式访问邮箱（以 Gmail 为例）
#

EMAIL="iveteran.yuu@outlook.com"
#ACCESS_TOKEN="ya29.a0ARrdaM8jxxxx..."   # 你的 OAuth2 Access Token
#ACCESS_TOKEN="EwA4BMl6BAAUBKgm8k1UswUNwklmy2v7U/S+1fEAAR1iO4lXo2GbWda5br8oW6varT0t+Pp/FC7/CkgszjjOBzF9mnOWt09ZZKKUcWWlgqTCt7oEINTt8I9GXz5WzHMWEBXqEQhSnuCkHCxJdvFfAb0rXk9rTpowVIUrVwanZUPtziWGSrdFFnpht6FHvsH+5ZJPGFkxEKZ1d6KuDqE479Y5iwfcRLGxwyi6AQB2C1CJwsoeBqKZIECzNgcm7Q/6Gr5vTfSBhD/Uq/qLptpYitaHKTz4EbOtZL1VYpjWzf6ZwPodBXgUl7r1Tcf+gRjgMWISbAKwao8f4df85rnqNovCwvqJ60h2QR+4VrY23FZyWe24I1HbKDhc+PB1dJAQZgAAENemIo1wB5n8N9a/RoEaXhsAA4f+wHvWPjIHUWcLG6TF8Almk6fWAd44bpeDTKfAqTIKnuGBcal1LQOOwLWxa0/FXIvwGkfvhSPKaUXsS7B7gOop2dKFLs3TN0e/808sOIqq1IWoPnQDnCdSvmuy20PfKA/X/Gp9dJwL8r3HJDK7LEAnPOHzrSqaxHkxDBXAScpS4Dhmh1PlgeARgvQQr0bHrCIvvjrc6BZux89pAFpkPnzyX3Nu0KRfIhexkhzRA+OYHFI34Ivi0f3ZVRf8EAa5cSctJWIEu6jdjPXDNtoeYB4/Dk1KihZ21TXP6HSrb9tjz7DNV9DFhKeJ2cBC0gCv1LAUTk7lwNIRkKXpg34HR38kYXnNiNJxH9ZMySHmWr30q/UzgWCTMCti1OYvkf3+5yxqZGOGpn15SKcEQSlE+5yV8Rn1fbVlyW0o1SBBh4Fndao0vFuIeBWMm1Oo7LSjMTSDUf1JWfYlyc8289rkR9Y5ruejwH7d0qqge18y+HDUohZCmYa6tciy1hViFGanfCFS6gMeKu9JBoDyewG3LTH7GyrDiiByR8c4sTXXWPw6lytTiqjfdyjyNoN+181xcch4UiYmld/XRSnxzzvW6V3iJduaRNP6VoDxUBt9cXBLUFadmIGmIkDp7vQCdJrLHed7QjltOZ9Ca44+9rNFcrFd2mBB/kTaa+T165n8uPc7J4wWfcd8MKY21BCys7RcbpL38sQ4uCzfpRhD2zdue0wR7VJO7HU3pQ/O+b2DGffZcNHtY78VXnJM096iFngKYCzA8I/7oQp1D42UkWAcLV3qcXppWr1DRcaL7ho0/j0pr84vlFVkpev8Yha+f0hHiv7kQZ6npbiI1XuyCMa2E5ETQBbKXARHVjRiTzFteS6bKKJj8+ycq83XsWVNBPcarX6npik9XidXBGehZwB6t3eK7clBXdhgXo/b5JOuoYrG3eL6gP9S/hKpYFAsCWq15PH7gqn38eMpLBpj41NxAN6heNATkQJquIp1OGt/CVh4veSi6pcA8GLYDY/M58Ib7UUD"
ACCESS_TOKEN="EwA4BMl6BAAUBKgm8k1UswUNwklmy2v7U/S+1fEAAcTePTa67ms/EUtk0MTF7Yqf8cuR9RD4/fCyKIvM4VxcsGHrsnb1iMtOFc2XMcE1flB53yAbMLTMjjC8aOQCJZSLvjtxE/13rSeKy3LD16pZ3nBokLH3hQVyHf9ISDPx1LBXd19kYBgP/yzPcTWeJK2xxoX/j++KwIaC8SvF/W126DLIKIMQ/2pS/O9yhAiyiBOSaHqyOJhbvIEGPSPgy/lpBxYWJZr6VE25AfW/Pul/+AGLxQ5ZPRQ7QROvCyBqfY+AhNDQGXoGEtMJyEbIXt0HC85Jd3oiO9WlojuZmvVvkC+LzarVVB3EtKBnuQpxgL9e4v70G+6AJzE4T1Ci9KUQZgAAEFeIXlO+xyGDP1EZhKvjh/8AAwfgrGkhGxMyBBo0Elg4/I6tH4KkFp7BcUBwTEDYGLA1lpQhTQiXhoFG00TOPPzYRgMA6Mkl6pyVRwpdNxYyNcTRJLxbD4Wd/sjZ3vUK2vFOCxBAlTziwunio2s8iJioK3JeSb0MD9Zf9NLoluXgW7f2FmhtERfAw2J5TQQ2/7lTO/787X/ySRkMgQ78wkwO54HY+ILUrvxP9IK7O85EZtdGovv43vlezDvNKyU2DF0toRVLKo1IrJ4eSxaWkPqRdrN6LrL+dzE64Wphtzqz8M60fa4N+Oi9oDOcyo+T9OXtgUUf++qNN5/XevXje1JLtkA93nad5C8oYWZLP17OYR6+9x2r+Oq965WFhIKc5jjm9uaN9ONXXzlqCJQ7VGgq+vmV4UvJ3f5r5KWViTygEpD+OkoSk743BhG1DwfSyUeq5bGS71djGF04oemrTbQ4KgCuGxmXl/5rQ72fiwbtqD5nVoNxTslxiYV94rJbrE6jLe7Z8wc9OHep+SJc7HN+hIoipHduOCt4SzO9bYUcs qcN/4+16Y5wxsyxEPqdamqWmql4qHkQo6csdsSGTqSusxUxxEkWFn7Fq3fcKqFuabpEyzHok6AeNnOn2XGajGQnVr3Hi437yojrjjIpw4A kshWrpbdR3NUZ8WWzNpy9i6f0M4TWOx1SuPkbnWaWyIEKPXQzqrDTDSlAbTebs8WE1cNUsvmj0sNUtZqs42NyPH9/Bj7VFscR0VgFSnlzt JxYZ5gcN8iaTlppS9uI4jAZXp+hmMI7JGXsFG3zcUl5OdL0DRQnCDeDJSgt32jqtkIXzgKOcnfV926R2KLFjC7Y6sZxMA31PGizd/K0QLMtgJmi3elQIUbC241RRfUq6aCoKIt4fOwS1hZ+zVu2tUIiUGzjB3jAsOoF2xfK4do1/JUmKzwQcNbC8MqYBAOmZruXWxiXBbVQ2NKCjjU6N57W3tOJLm6Tb8MYdR3n1j9VkWHE8BrgPTPnY0RK6VY3LmR+VCA9Pt8KqI4RgS2xlxG01kUD"

IMAP_SERVER="outlook.office365.com"
IMAP_PORT=993

# 构造 XOAUTH2 字符串
AUTH_STRING="user=${EMAIL}\x01auth=Bearer ${ACCESS_TOKEN}\x01\x01"
# Base64 编码
AUTH_STRING_B64=$(printf "${AUTH_STRING}" | base64 | tr -d '\n')

echo "=== 尝试使用 XOAUTH2 登录 IMAP ==="

# 使用 curl 执行 IMAP 命令
# 列出所有folders
#curl -v -s --url "imaps://${IMAP_SERVER}:${IMAP_PORT}" \
#     --user "$EMAIL" \
#     --oauth2-bearer "$ACCESS_TOKEN"
#
# 列出Inbox前5封邮件
curl -v -s --url "imaps://${IMAP_SERVER}:${IMAP_PORT}/INBOX" \
     --user "$EMAIL" \
     --oauth2-bearer "$ACCESS_TOKEN" \
     --request "FETCH 1:5 (BODY[HEADER.FIELDS (SUBJECT)])"

## 创建folder
#curl -v -s --url "imaps://${IMAP_SERVER}:${IMAP_PORT}" \
#     --user "$EMAIL" \
#     --oauth2-bearer "$ACCESS_TOKEN" \
#     --request "CREATE IncontrolChat"
